<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" type="text/css" href="../css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../css/bootstrap-datetimepicker.min.css" />
    <link rel="stylesheet" href="../layui/css/layui.css" />
    <link rel="stylesheet" type="text/css" href="../css/style.css" />
    <script src="../js/jquery-3.1.1.min.js" type="text/javascript"></script>
    <script src="../js/bootstrap.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="../js/jquery.bootstrap.min.js"></script>
    <script src="../js/dropdown.js" type="text/javascript"></script>
    <script src="../js/modal.js" type="text/javascript"></script>
    <script type="text/javascript" src="../layui/layui.js"></script>
    <title>车报废管理系统-旧件回收</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        a {
            text-decoration: none;
        }

            a:hover {
                text-decoration: none;
            }

        .tcdPageCode {
            padding: 15px 20px;
            text-align: left;
            color: #ccc;
            text-align: center;
        }

            .tcdPageCode a {
                display: inline-block;
                color: #428bca;
                display: inline-block;
                height: 25px;
                line-height: 25px;
                padding: 0 10px;
                border: 1px solid #ddd;
                margin: 0 2px;
                border-radius: 4px;
                vertical-align: middle;
            }

                .tcdPageCode a:hover {
                    text-decoration: none;
                    border: 1px solid #428bca;
                }

            .tcdPageCode span.current {
                display: inline-block;
                height: 25px;
                line-height: 25px;
                padding: 0 10px;
                margin: 0 2px;
                color: #fff;
                background-color: #428bca;
                border: 1px solid #428bca;
                border-radius: 4px;
                vertical-align: middle;
            }

            .tcdPageCode span.disabled {
                display: inline-block;
                height: 25px;
                line-height: 25px;
                padding: 0 10px;
                margin: 0 2px;
                color: #bfbfbf;
                background: #f2f2f2;
                border: 1px solid #bfbfbf;
                border-radius: 4px;
                vertical-align: middle;
            }

        .gun::-webkit-scrollbar {
            display: none;
        }

        .gun {
            padding-left: 10px;
        }
    </style>
    <title>车报废管理后台</title>
</head>
<body>
    <div class="back-stage-top">
        <h1 class="pull-left">车报废管理后台</h1>
        <h1 class="pull-right text-primary" id="loginout" style="margin-left:20px;cursor:pointer;font-size:18px;margin-right:50px;" onclick="loginout()">退出</h1>
        <h1 class="pull-right text-primary" id="loginusername" style="margin-left:20px;font-size:18px;">用户名：张三</h1>
    </div>
    <div class="backnav">
        <ul class="backnav">
            <li><a href="index.html">首页</a></li>
            <li><a href="orderlist.html">订单管理</a></li>
            <li><a href="scraplist.html">报废汽车</a></li>
            <li><a href="jiulist.html">旧件回收</a></li>
            <li><a href="moneymanage.html">财务管理</a></li>
            <li class="cur"><a href="system.html">系统设置</a></li>
        </ul>
    </div>
    <div class="tablebox">
        <div style="position:relative;">
            <div class="leftbar">
                <ul class="leftbar-nav">
                    <li role="presentation" class="active"><a href="role.html">角色管理</a></li>
                    <li role="presentation"><a href="user.html">用户管理</a></li>
                    <li role="presentation"><a href="customer.html">客户管理</a></li>
                    <li role="presentation"><a href="area.html">区域管理</a></li>
                    <li role="presentation"><a href="">预警管理</a></li>
                    <li role="presentation"><a href="">区域管理</a></li>
                    <li role="presentation"><a href="">配件数据管理</a></li>
                    <li role="presentation"><a href="residual-value.html">整车残值评估管理</a></li>
                </ul>
            </div>
        </div>
        <div class="rightbar">
            <ol class="breadcrumb">
                <li><a href="index.html">首页</a></li>
                <li><a href="system.html">系统设置</a></li>
                <li>角色管理</li>
            </ol>
            <div class="searchbox">
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchval" placeholder="角色名称" />
                        <span class="input-group-btn">
                            <button class="btn btn-default" id="searbtn" type="button">查询</button>
                        </span>
                    </div>
                </div>
                <div class="pull-right"><button type="button" class="btn btn-info adddata">+ 添加</button></div>
                <div class="clearfix"></div>
            </div>
            <table class="table table-striped tdmain">
                <thead>
                    <tr>
                        <th>角色名称</th>
                        <th width="60%">权限</th>
                        <th>编辑</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div class="page" style="background: #fff;">
                <div class="tcdPageCode"></div>
            </div>

            <br /><br /><br />
        </div>
        <div class="page-header"></div>
        <!--<div class=" text-center"><a role="button" href="" class="btn btn-default">返回</a></div>-->
    </div>
    <div class="hide">
        <div id="shan">
            确定删除吗？
        </div>
    </div>
    <div class="hide">
        <div id="bian">
            <div class="form-group form-inline clearfix">
                角色名称
                <input type="text" value="" style="width:400px;" class="form-control checkLogs" id="jiaoname" placeholder="" autocomplete="off" />
            </div>
            <div class="form-group form-inline clearfix">
                <b>WEB后台：</b>	<br />
                <div class="xuan1" style="overflow: auto;">

                </div>
            </div>
            <div class="form-group form-inline clearfix">
                <b>APP管理：</b><br />
                <div class="xuan2" style="overflow: auto;">

                </div>
            </div>

        </div>
    </div>
    <script src="../js/jquery.page.js"></script>
    <script src="../js/comm.js"></script>
    <script>
        layui.use('layer', function () {

        })
        $("#searbtn").on("click", function (event) {
            event.preventDefault();
            //var type=$(this).attr("data-type");
            var val = $("#searchval").val();
            showdata(1, val);
        });
        function showdata(x, z) {
            $.ajax({
                type: "get",
                url: href + "role",
                data: {
                    page: x,
                    rows: 10,
                    rolename: z
                },
                contentType: "application/json",
                dataType: "json",
                success: function (data) {
                    if (data.msg == "success") {
                        var otr = "";
                        var d = data.data.rows;
                        if (d.length) {
                            for (var i = 0; i < d.length; i++) {
                                otr += '<tr>'
                                otr += '<td>' + d[i].rolename + '</td>'
                                otr += '<td>' + d[i].permissionsName + '</td>'
                                otr += '<td>'
                                otr += '<button data-name="' + d[i].rolename + '" role="button" class="btn btn-default btn-sm cha" data-id="' + d[i].id + '" >'
                                otr += '<span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>编辑 </button>'
                                otr += '<button type="button" class="btn btn-default btn-sm shan" data-id="' + d[i].id + '">'
                                otr += '<span class="glyphicon glyphicon-remove"  ></span>删除</button>'
                                otr += '</td></tr>'
                            }
                        } else {
                            otr = '<tr><td colspan=' + $(".tdmain th").length + ' style="text-align:center">无数据</td></tr>'
                        }
                        $(".tdmain tbody").html(otr);
                        $(".page").html("");
                        $(".page").html('<div class="tcdPageCode"></div>');
                        $(".tcdPageCode").createPage({
                            pageCount: Math.ceil(data.data.total / 10),
                            current: x,
                            backFn: function (p) {
                                showdata2(p, z)
                            }
                        });
                    }

                }

            });
        };
        function showdata2(x, z) {
            $.ajax({
                type: "get",
                url: href + "role",
                data: {
                    page: x,
                    rows: 10,
                    rolename: z
                },
                contentType: "application/json",
                dataType: "json",
                success: function (data) {
                    if (data.msg == "success") {
                        var otr = "";
                        var d = data.data.rows;
                        if (d.length) {
                            for (var i = 0; i < d.length; i++) {
                                otr += '<tr>'
                                otr += '<td>' + d[i].rolename + '</td>'
                                otr += '<td>' + d[i].permissionsName + '</td>'
                                otr += '<td>'
                                otr += '<button data-name="' + d[i].rolename + '" role="button" class="btn btn-default btn-sm cha" data-id="' + d[i].id + '" >'
                                otr += '<span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>编辑 </button>'
                                otr += '<button type="button" class="btn btn-default btn-sm shan" data-id="' + d[i].id + '">'
                                otr += '<span class="glyphicon glyphicon-remove"  ></span>删除</button>'
                                otr += '</td></tr>'
                            }
                        } else {
                            otr = '<tr><td colspan=' + $(".tdmain th").length + ' style="text-align:center">无数据</td></tr>'
                        }
                        $(".tdmain tbody").html(otr);
                        $(".page").html("");
                        $(".page").html('<div class="tcdPageCode"></div>');
                        $(".tcdPageCode").createPage({
                            pageCount: Math.ceil(data.data.total / 10),
                            current: x,
                            backFn: function (p) {
                                showdata(p, z)
                            }
                        });
                    }

                }

            });
        }
        showdata(1, "", "");
        //删除
        $(document).delegate('.shan', 'click', function (event) {
            event.preventDefault();
            var id = $(this).attr("data-id");
            $('#shan').dialog({
                title: '删除',
                onClose: function () {
                    $(this).dialog('close');
                },
                buttons: [{
                    text: '取消',
                    'click': function () {
                        $(this).dialog('close');
                    }
                }, {
                    text: '确定',
                    'class': 'btn-primary',
                    'click': function () {
                        $.ajax({
                            type: "DELETE",
                            url: href + "role/" + id,
                            dataType: 'json',
                            success: function (data) {
                                if (data.msg == "success") {
                                    layer.msg('<span style="font-size:20px">删除成功</span>', {
                                        time: 1000, //2s后自动关闭
                                    }, function () {
                                        window.location.reload()
                                    });
                                }
                            }

                        });
                    }
                }]
            })
        });
        //添加
        $(document).delegate('.adddata', 'click', function (event) {
            event.preventDefault();
            $("#jiaoname").val("");
            $.ajax({
                type: "get",
                url: href + "permission/gettree",
                dataType: 'json',
                success: function (data) {
                    if (data.msg == "success") {
                        var d = data.data[0].sub;
                        var f = data.data[1].sub;
                        if (d.length) {
                            var otr = ""
                            for (var i = 0; i < d.length; i++) {
                                var classnew = "newclassa" + i;
                                otr += "<ul class='gun' style='float:left;width:30%;min-height:150px;max-height:200px;overflow:hidden;overflow-y:scroll'>"
                                otr += '<li> <input class="' + classnew + ' fquan hqu" data-id="' + d[i].id + '" type="checkbox" /> <span>' + d[i].name + '</span></li>'
                                var dd = d[i].sub;
                                if (dd.length) {
                                    for (var j = 0; j < dd.length; j++) {
                                        var classnewx = classnew + "_x" + j;
                                        otr += '<li style="padding-left:10px"><input class="' + classnewx + ' xqu hqu"  data-id="' + dd[j].id + '" type="checkbox" />  <span>' + dd[j].name + '</span></li>'
                                    }
                                }
                                otr += "</ul>"
                            };
                            $(".xuan1").html(otr)
                        };
                        if (f.length) {
                            var otr = ""
                            for (var i = 0; i < f.length; i++) {
                                var classnew = "newclassb" + i;
                                otr += "<ul class='gun' style='float:left;width:30%;min-height:150px;max-height:200px;overflow:hidden;overflow-y:scroll'>"
                                otr += '<li> <input class="' + classnew + ' fquan hqu" data-id="' + f[i].id + '" type="checkbox" /> <span>' + f[i].name + '</span></li>';
                                var dd = f[i].sub;
                                if (dd.length) {
                                    for (var j = 0; j < dd.length; j++) {
                                        var classnewx = classnew + "_x" + j;
                                        otr += '<li style="padding-left:10px"><input class="' + classnewx + ' xqu hqu " data-id="' + dd[j].id + '" type="checkbox" />  <span>' + dd[j].name + '</span></li>';
                                    }
                                }
                                otr += "</ul>"
                            };
                            $(".xuan2").html(otr)
                        };

                    }
                }

            });

            $('#bian').dialog({
                title: '添加',
                onClose: function () {
                    $(this).dialog('close');
                },
                buttons: [{
                    text: '取消',
                    'click': function () {
                        $(this).dialog('close');
                    }
                }, {
                    text: '确定',
                    'class': 'btn-primary',
                    'click': function () {
                        var jiaona = $("#jiaoname").val();
                        if (jiaona == "" || jiaona == null) {
                            layer.msg('<span style="font-size:20px">请填写角色名称</span>', {
                                time: 2000, //2s后自动关闭
                            });
                            return;
                        };
                        var arrids = [];
                        for (var i = 0; i < $(".hqu").length; i++) {
                            if ($(".hqu").eq(i).prop("checked") == true) {
                                arrids.push($(".hqu").eq(i).attr("data-id"))
                            }
                        };
                        var ids = arrids.join();
                        if (ids == "" || ids == null) {
                            layer.msg('<span style="font-size:20px">请选择权限范围</span>', {
                                time: 2000, //2s后自动关闭
                            });
                            return;
                        }
                        $.ajax({
                            type: "post",
                            url: href + "role",
                            data: {
                                rolename: jiaona,
                                permissionIds: ids
                            },
                            dataType: "json",
                            success: function (data) {
                                if (data.msg == "success") {
                                    layer.msg('<span style="font-size:20px">添加成功</span>', {
                                        time: 1000, //2s后自动关闭
                                    }, function () {
                                        window.location.reload()
                                    });
                                }
                            }
                        });
                    }
                }]
            })
        });
        //编辑
        $(document).delegate('.cha', 'click', function (event) {
            event.preventDefault();
            var id = $(this).attr("data-id");
            var name = $(this).attr("data-name");
            $("#jiaoname").val(name);
            $.ajax({
                type: "get",
                url: href + "role/" + id,
                dataType: 'json',
                success: function (data) {
                    if (data.msg == "success") {
                        var d = data.data.permissions[0].sub;
                        var f = data.data.permissions[1].sub;
                        if (d.length) {
                            var otr = ""
                            for (var i = 0; i < d.length; i++) {
                                var classnew = "newclassa" + i;
                                otr += "<ul class='gun' style='float:left;width:30%;min-height:150px;max-height:200px;overflow:hidden;overflow-y:scroll'>"
                                if (d[i].checked == true) {
                                    otr += '<li> <input checked class="' + classnew + ' fquan hqu" data-id="' + d[i].id + '" type="checkbox" /> <span>' + d[i].name + '</span></li>'
                                } else {
                                    otr += '<li> <input class="' + classnew + ' fquan hqu" data-id="' + d[i].id + '" type="checkbox" /> <span>' + d[i].name + '</span></li>'
                                }

                                var dd = d[i].sub;
                                if (dd.length) {
                                    for (var j = 0; j < dd.length; j++) {
                                        var classnewx = classnew + "_x" + j;
                                        if (dd[j].checked == true) {
                                            otr += '<li style="padding-left:10px"><input checked class="' + classnewx + ' xqu hqu"  data-id="' + dd[j].id + '" type="checkbox" />  <span>' + dd[j].name + '</span></li>'
                                        } else {
                                            otr += '<li style="padding-left:10px"><input class="' + classnewx + ' xqu hqu"  data-id="' + dd[j].id + '" type="checkbox" />  <span>' + dd[j].name + '</span></li>'
                                        }

                                    }
                                }
                                otr += "</ul>"
                            };
                            $(".xuan1").html(otr)
                        };
                        if (f.length) {
                            var otr = ""
                            for (var i = 0; i < f.length; i++) {
                                var classnew = "newclassb" + i;
                                otr += "<ul class='gun' style='float:left;width:30%;min-height:150px;max-height:200px;overflow:hidden;overflow-y:scroll'>"
                                if (f[i].checked == true) {
                                    otr += '<li> <input checked class="' + classnew + ' fquan hqu" data-id="' + f[i].id + '" type="checkbox" /> <span>' + f[i].name + '</span></li>'
                                } else {
                                    otr += '<li> <input class="' + classnew + ' fquan hqu" data-id="' + f[i].id + '" type="checkbox" /> <span>' + f[i].name + '</span></li>'
                                }
                                var dd = f[i].sub;
                                if (dd.length) {
                                    for (var j = 0; j < dd.length; j++) {
                                        var classnewx = classnew + "_x" + j;
                                        if (dd[j].checked == true) {
                                            otr += '<li style="padding-left:10px"><input checked class="' + classnewx + ' xqu hqu"  data-id="' + dd[j].id + '" type="checkbox" />  <span>' + dd[j].name + '</span></li>'
                                        } else {
                                            otr += '<li style="padding-left:10px"><input class="' + classnewx + ' xqu hqu"  data-id="' + dd[j].id + '" type="checkbox" />  <span>' + dd[j].name + '</span></li>'
                                        }
                                    }
                                }
                                otr += "</ul>"
                            };
                            $(".xuan2").html(otr)
                        };

                    }
                }

            });
            $('#bian').dialog({
                title: '编辑',
                onClose: function () {
                    $(this).dialog('close');
                },
                buttons: [{
                    text: '取消',
                    'click': function () {
                        $(this).dialog('close');
                    }
                }, {
                    text: '确定',
                    'class': 'btn-primary',
                    'click': function () {
                        var arrids = [];
                        for (var i = 0; i < $(".hqu").length; i++) {
                            if ($(".hqu").eq(i).prop("checked") == true) {
                                arrids.push($(".hqu").eq(i).attr("data-id"))
                            }
                        };
                        var ids = arrids.join();
                        if (ids == "" || ids == null) {
                            layer.msg('<span style="font-size:20px">请选择权限范围</span>', {
                                time: 2000, //2s后自动关闭
                            });
                            return;
                        }

                        $.ajax({
                            type: "put",
                            url: href + "role/" + id,
                            data: {
                                rolename: $("#jiaoname").val(),
                                permissionIds: ids
                            },
                            dataType: "json",
                            success: function (data) {
                                if (data.msg == "success") {
                                    layer.msg('<span style="font-size:20px">修改成功</span>', {
                                        time: 1000, //2s后自动关闭
                                    }, function () {
                                        window.location.reload()
                                    });
                                }
                            }
                        });
                    }
                }]
            })
        });
        $(document).delegate('.fquan', 'change', function () {
            var classname = $(this).attr("class").split(' ')[0];
            if (classname.indexOf("_") < 0) {
                if ($(this).prop("checked") == true) {
                    classname = classname + "_x";
                    $("input[type='checkbox'][class*='" + classname + "']").prop("checked", true);
                }
                else {
                    classname = classname + "_x";
                    $("input[type='checkbox'][class*='" + classname + "']").prop("checked", false);
                }
            }
        })
        //选择权限
        $(document).delegate('.xqu', 'change', function (event) {
            event.preventDefault();
            if ($(this).prop("checked") == true) {
                $(this).parent().parent().find(".fquan").prop("checked", true);
            } else {
                var d = $(this).parent().parent().find(".xqu");
                var t = 1;
                if (d.length) {
                    for (var i = 0; i < d.length; i++) {
                        if (d.eq(i).prop("checked") == true) {
                            t = 2
                        }
                    }
                };
                if (t == 1) {
                    $(this).parent().parent().find(".fquan").prop("checked", false);
                }
            }
        });
        clearnull();
    </script>
</body>
</html>
