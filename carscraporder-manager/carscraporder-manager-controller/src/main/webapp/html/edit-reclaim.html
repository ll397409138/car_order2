<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" type="text/css" href="../css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../css/bootstrap-datetimepicker.min.css" />
    <link rel="stylesheet" href="../layui/css/layui.css" />
    <link rel="stylesheet" type="text/css" href="../css/style.css" />

    <link rel="stylesheet" href="../lookpic/css/bootstrap-grid.min.css" />
    <link rel="stylesheet" href="../lookpic/dist/zoomify.min.css" />
    <link rel="stylesheet" href="../lookpic/css/style.css" />
    <link href="../video/src/css/videoplayer.css" rel="stylesheet" />
    <script src="../js/jquery-3.1.1.min.js" type="text/javascript"></script>
    <script src="../js/bootstrap.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="../js/jquery.bootstrap.min.js"></script>
    <script src="../js/dropdown.js" type="text/javascript"></script>
    <script src="../js/modal.js" type="text/javascript"></script>
    <script type="text/javascript" src="../layui/layui.js"></script>
    <script src="../lookpic/dist/zoomify.min.js"></script>
    <style>
        .displaynone {
            display: none;
        }
        .baofeipics img {
            width: 133px;
            height: 77px;
        }
    </style>
    <title>车报废管理后台</title>
    <script type="text/javascript">
        $('.dropdown-toggle').dropdown()
    </script>
</head>
<body>
    <div class="back-stage-top">
        <h1 class="pull-left">车报废管理后台</h1>
        <h1 class="pull-right text-primary" id="loginout" style="margin-left:20px;cursor:pointer;font-size:18px;margin-right:50px;" onclick="loginout()">退出</h1>
        <h1 class="pull-right text-primary" id="loginusername" style="margin-left:20px;font-size:18px;">用户名：张三</h1>
    </div>
    <div class="backnav">
        <ul class="backnav">
            <li><a href="index.html">首页</a></li>
            <li><a href="orderlist.html">订单管理</a></li>
            <li><a href="scraplist.html">报废汽车</a></li>
            <li class="cur"><a href="jiulist.html">旧件回收</a></li>
            <li><a href="moneymanage.html">财务管理</a></li>
            <li><a href="system.html">系统设置</a></li>
        </ul>
    </div>
    <div class="tablebox">
        <ol class="breadcrumb m-t-10">
            <li><a href="index.html">首页</a></li>
            <li><a href="jiulist.html">旧件回收</a></li>
            <li>查看</li>
        </ol>
        <!--配件信息-->
        <h2 class="text-center">订单信息：<span class="dingbian"></span></h2>
        <div class="col-md-10">
            <table class="table table-bordered">
                <tr>
                    <th width="10%" class="text-right">业务员：</th>
                    <td width="10%"><span class="yewu"></span></td>
                    <th width="10%" class="text-right">委托单位：</th>
                    <td><span class="weituo"></span></td>
                </tr>
                <tr>
                    <th width="120" class="text-right">派单备注：</th>
                    <td colspan="3"><span class="paibei"></span></td>
                </tr>
            </table>
        </div>
        <div class="col-md-2">
            <h2><span class="label label-primary antai"></span></h2>
        </div>
        <div class="col-md-12">
            <h4 class="page-header"><span class="glyphicon glyphicon-list-alt m-l-15"></span> 配件信息</h4>
            <table class="tablelist" width="100%">
                <tr>
                    <th width="100" class="text-right"><span class="redcolor">*</span>配件分类：</th>
                    <td>
                        <select class="form-control" id="m-lei" style="width:400px"></select>
                    </td>
                </tr>
                <tr>
                    <th width="100" class="text-right"><span class="redcolor">*</span>配件名称：</th>
                    <td>
                        <select class="form-control" id="m-name" style="width:400px"></select>
                    </td>
                </tr>
                <tr>
                    <th width="100" class="text-right">零件编号：</th>
                    <td><input class="form-control biannum" placeholder="" required=required autofocus=autofocus autofocus=autofocus type="text" /></td>
                </tr>
                <tr>
                    <th width="100" class="text-right">接收备注：</th>
                    <td><span class="jiebei"></span></td>
                </tr>
                <tr>
                    <th width="100" class="text-right">入库备注：</th>
                    <td><span class="rubei"></span></td>
                </tr>
            </table>
        </div>
        <!--end 配件信息-->

        <div class="col-md-4">
            <h4 class="page-header"><span class="glyphicon glyphicon-list-alt m-l-15"></span> 配件照片</h4>
            <div class="row rw1">

            </div>
        </div>
        <div class="col-md-4">
            <h4 class="page-header"><span class="glyphicon glyphicon-list-alt m-l-15"></span> 配件接收照片</h4>
            <div class="row rw2">

            </div>
        </div>
        <div class="col-md-4">
            <h4 class="page-header"><span class="glyphicon glyphicon-list-alt m-l-15"></span> 配件入库照片</h4>
            <div class="row rw3">

            </div>
        </div>
        <div class="clearfix page-header p-tb30"></div>

        <div class="row">
            <div class="col-md-6" style="min-height:300px;">
                <h4 class="page-header"><span class="glyphicon glyphicon-list-alt m-l-15"></span> 报废照片</h4>
                <table class="tablelist" style="width:100%;">
                    <tr>
                        <td class="baofeipics">
                            <div class="col-md-4 col-xs-6">
                                <div class="thumbnail">
                                    <img src="../img/addimg-bg.png" alt="" onclick="addactpic()" />
                                    <form enctype="multipart/form-data" method="post">
                                        <input style="display: none;" type="file" multiple="multiple" accept=".png,.jpg,.jpeg,.gif,.PNG,.JPG,.JPEG,.GIF" name="upload" class="upload2" onchange="doUpload2()" />
                                    </form>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="col-md-6" style="min-height:300px;">
                <h4 class="page-header"><span class="glyphicon glyphicon-list-alt m-l-15"></span> 报废视频</h4>
                <table class="tablelist">
                    <tr>
                        <td><b>上传视频：</b><input type="hidden" value="" id="shipinid"/></td>
                        <td class="videourl" style="height:220px;width: 490px;">
                            <div class="thumbnail" style="height:230px;width: 490px;">
                                <div class="thumbnail img-input-box" id="addvideodiv" style="width: 100%;height:100px;border:none;">
                                    <img src="../img/addimg-bg.png" alt="" onclick="addVideo()" style="height:200px;" />
                                    <form enctype="multipart/form-data" method="post">
                                        <input style="display: none;" type="file" accept=".MOV,.ASF,.RM,.NAVI,.DivX,.MP4,.MPEG,.WMV" name="doUploadVideo" class="doUploadVideo" onchange="doUploadVideoFunc()" />
                                    </form>
                                </div>
                                <div class="mod-yivideo-warp displaynone" style="width: 100%;height:280px;" id="mod_player"></div>
                            </div>
                            <span style="text-decoration:underline;cursor:pointer;font-size:14px;color:#000000;" onclick="addVideo();">点击重新上传视频</span>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <div class="text-center m-b-20">
            <button class="btn btn-primary btn-lg m-r-10 bao">保存</button>
        </div>
    </div>
    <script src="../js/comm.js"></script>
    <script src="../video/build/videoplayer.min.js"></script>
    <script>
        (function ($) {
            $.getUrlParam = function (name) {
                var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
                var r = window.location.search.substr(1).match(reg);
                if (r != null) return unescape(r[2]);
                return null;
            }
        })(jQuery);
        var id = $.getUrlParam('id');
        layui.use('layer', function () {

        });

        //点击添加图片
        function addactpic() {
            $(".upload2").get(0).click();
        }

        //上传图片
        function doUpload2() {
            var formData = new FormData();
            if ($(".upload2")[0].files.length == 0) {
                alert("请选择pc母版！");
                return false;
            };
            formData.append("files", $(".upload2")[0].files[0]);
            $.ajax({
                url:"http://60.205.223.142/carscraporder-attachment/upload/carattachment/"+id+"?businessType=2&pictureType=4",
                type: "POST",
                data: formData,
                dataType: "json",
                async: false,
                cache: false,
                contentType: false,
                processData: false,
                success: function (data) {
                    console.log(data);
                    var otr = ""
                    if (data.msg == "success") {
                        if (data.data.length) {
                            for (var i = 0; i < data.data.length; i++) {
                                otr += '<div class="col- md-4 col-xs-4 addpic" data-id="' + data.data[i].id + '">';
                                otr += '<div class="thumbnail">';
                                otr += '<img class="img-rounded zoomify"  src="' + data.data[i].url + '" alt="" />';
                                otr += '<button type="button" class="del-btn"  onclick="delpic(this,' + data.data[i].id + ')"><span class="glyphicon glyphicon-remove"></span></button>';
                                otr += '</div>';
                                otr += '</div>';
                            }
                        }
                    };
                    $(".baofeipics").append(otr)
                },
                error: function (returndata) {
                    alert("操作失败");
                }
            });
        };
        //删除图片
        function delpic(x, picid) {
            $.ajax({
                url: "http://60.205.223.142/carscraporder-manager/carattachment/" + picid,
                type: "delete",
                dataType: "json",
                headers: {
                    Accept: "application/json; charset=utf-8"
                },
                success: function (obj) {
                    console.log(obj);
                    if (obj.msg == "success") {
                        $(x).parent().parent().remove();
                    }
                }
            });
        }

        //重新上传视频
        function reuploadrideo() {
            var picid = $("#shipinid").val();
            if (picid) {
                $.ajax({
                    url: "http://60.205.223.142/carscraporder-manager/autoparts/removeFile?attachmentId=" + picid,
                    async: false,
                    type: "DELETE",
                    dataType: "json",
                    success: function (obj) {
                        console.log(obj);
                        if (obj.msg == "success") {
                            if (obj.data) {
                                //console.log("删除视频id成功=" + picid);
                            }
                        }
                    }
                });
            }
        }

        //上传视频
        function addVideo() {
            $(".doUploadVideo").get(0).click();
        };
        //上传视频
        function doUploadVideoFunc() {
            var formData = new FormData();
            if ($(".doUploadVideo")[0].files.length == 0) {
                alert("请选择pc母版！");
                return false;
            };
            var pics = $(".doUploadVideo")[0].files[0].name.toUpperCase();
            if (!/\.(MOV|ASF|RM|NAVI|DivX|MP4|MPEG|WMV)$/.test(pics)) {
                alert("请上传正确视频格式");
                $(".upload2").val("");
                return;
            };
            var sizes = $(".doUploadVideo")[0].files[0].size;
            var pan = Math.round(sizes / 1024 * 100) / 100;
            if (pan > 20480) {
                alert("所传视频不能大于20M");
                return;
            };
            formData.append("file", $(".doUploadVideo")[0].files[0]);
            $.ajax({
                type: "POST",
                url: "http://60.205.223.142/carscraporder-manager/autoparts/importFile?id=" + id,
                data: formData,
                timeout: 600000,
                dataType: "json",
                contentType: false,
                processData: false,
                async: false,
                headers:{
                    Accept: "application/json; charset=utf-8"
                },
                success: function (obj) {
                    reuploadrideo();//先删除原有视频
                    //console.log(JSON.stringify(obj));
                    if (obj.msg == "success") {
                        $("#mod_player").removeClass("displaynone");
                        $("#addvideodiv").addClass("displaynone");
                        if (obj.data) {
                            displayVideo(obj.data.url);
                        }
                    }
                    if (obj.code == "206") {
                        layer.msg('<span style="font-size:20px">上传失败。原因是：附件过大</span>', {
                            time: 2000, //2s后自动关闭
                        });
                        return;
                    }
                },
                error: function (e) {
                    console.log("视频上传失败，原因：" + e);
                }
            });
        }
        function displayVideo(urlstr) {
            $("#mod_player").removeClass("displaynone");
            $("#addvideodiv").addClass("displaynone");
            var videoplayer = videoPlayer('mod_player', {
                continuousPlay: false,
                autoPlay: false,
                canfast: true,
                width: '100%',
                height: '220px',
                virtualFullScreen: false,
                setSource: function (canplayTypes) {
                    console.log(canplayTypes);
                    return urlstr;
                },
                nextSource: function (canplayType) {

                },
                success: function (video, node, videoObj) {
                    // videoObj.fullScreen();
                    videoObj.timeupdate(function (currentTime) {
                        console.log(currentTime)
                    });
                }

            });
        }

        //判断状态
        function st(x) {
            if (x == 1) {
                x = "待接单 "
            };
            if (x == 2) {
                x = "待回收 "
            };
            if (x == 3) {
                x = "待入库"
            };
            if (x == 4) {
                x = "无法接收 "
            };
            if (x == 5) {
                x = "已入库"
            };
            if (x == 6) {
                x = "已出库"
            };
            if (x == 7) {
                x = "待结算"
            };
            if (x == 8) {
                x = "已完成"
            };
            if (x == 9) {
                x = "异常"
            };
            return x;
        };
        $.ajax({
            type: "get",
            url: href + 'autoparts/' + id + '/detail',
            dataType: "json",
            success: function (data) {
                if (data.msg == "success") {
                    var d = data.data;
                    $(".yewu").html(d.saleName);
                    $(".weituo").html(d.custormName);
                    $(".paibei").html(d.dispatchRemark);
                    lei(d.partsCaregoryId);
                    qibie(d.partsCaregoryId, d.partsType);
                    $(".biannum").val(d.partsNum);
                    $(".jiebei").html(d.receiveRemark);
                    $(".rubei").html(d.storageRemark);
                    $(".dingbian").html(d.orderNo);
                    $(".antai").html(st(d.orderAutopartsStatus))
                    var peipics = d.autoPartsPictures;
                    if (peipics.length) {
                        var otr = '';
                        for (var i = 0; i < peipics.length; i++) {
                            otr += '<div>'
                            otr += '<div>'
                            otr += '<img class="img-rounded" style="float:left;width:120px;height:90px;margin-left:10px" src="' + peipics[i].url + '" alt="" />'
                            otr += '</div></div>'
                        };
                        $(".rw1").html(otr);
                        //初始化话图片
                        $(".rw1  img").zoomify();
                    };
                    var peipics2 = d.autoPartsReceivePictures;
                    if (peipics2.length) {
                        var otr = '';
                        for (var i = 0; i < peipics2.length; i++) {
                            otr += '<div>'
                            otr += '<div>'
                            otr += '<img class="img-rounded" style="float:left;width:120px;height:90px;margin-left:10px" src="' + peipics2[i].url + '" alt="" />'
                            otr += '</div></div>'
                        };
                        $(".rw2").html(otr);
                        //初始化话图片
                        $(".rw2  img").zoomify();
                    };
                    var peipics3 = d.autoPartsWarehousingPictures;
                    if (peipics3.length) {
                        var otr = '';
                        for (var i = 0; i < peipics3.length; i++) {
                            otr += '<div>'
                            otr += '<div>'
                            otr += '<img class="img-rounded" style="float:left;width:120px;height:90px;margin-left:10px" src="' + peipics3[i].url + '" alt="" />'
                            otr += '</div></div>'
                        };
                        $(".rw3").html(otr);
                        //初始化话图片
                        $(".rw3  img").zoomify();
                    };
                    var peipics4 = d.autoPartsScrapPictures;
                    if (peipics4.length) {
                        otr = "";
                        for (var i = 0; i < peipics4.length; i++) {
                            otr += '<div class="col- md-4 col-xs-4 addpic" data-id="' + peipics4[i].id + '">';
                            otr += '<div class="thumbnail">';
                            otr += '<img class="img-rounded zoomify"  src="' + peipics4[i].url + '" alt="" />';
                            otr += '<button type="button" class="del-btn"  onclick="delpic(this,' + peipics4[i].id + ')"><span class="glyphicon glyphicon-remove"></span></button>';
                            otr += '</div>';
                            otr += '</div>';
                        }
                        $(".baofeipics").append(otr)
                    }

                    //添加视频
                    var ship = data.data.autoPartsVideo;
                    if (ship.length > 0) {
                        displayVideo(ship[0].url);
                        $("#shipinid").val(ship[0].id);
                    }
                }
            }
        })

        //配件分类
        function lei(x) {
            $.ajax({
                type: "get",
                url: href + "carPartsCategory",
                data: {
                    sessionid: ""
                },
                dataType: "json",
                success: function (data) {
                    var otr = '';
                    var d = data.data;
                    if (d.length) {
                        for (var i = 0; i < d.length; i++) {
                            otr += '<option data-type="' + d[i].id + '">' + d[i].partsCategoryName + '</option>'
                        };
                        $("#m-lei").html('<option data-type="">请选择配件分类</option>' + otr);
                        $("#m-lei option[data-type='" + x + "']").prop("selected", true);
                    } else {
                        $("#m-lei").html('<option data-type="">请选择配件分类</option>');
                        $("#m-name").html('<option data-type="">请选择配件名称</option>');
                    }
                }
            });
        }
        //配件名称变化
        function qibie(id, y) {
            $.ajax({
                type: "get",
                url: href + "carParts",
                data: {
                    categoryId: id
                },
                dataType: "json",
                success: function (data) {
                    var otr = '';
                    var d = data.data;
                    if (d.length) {
                        for (var i = 0; i < d.length; i++) {
                            otr += '<option data-type="' + d[i].id + '">' + d[i].partsName + '</option>'
                        };
                        $("#m-name").html(otr);
                        $("#m-name option[data-type='" + y + "']").prop("selected", true);
                    } else {
                        $("#m-name").html('<option data-type="">请选择配件名称</option>');
                    }
                }
            });
        };
        //监听配件类型的变化
        $('#m-lei').on('change', function (event) {
            event.preventDefault();
            var id = $('#m-lei option:selected').data('type');
            if (id == "") {
                $("#m-lei").html('<option data-type="">请选择配件分类</option>');
                $("#m-name").html('<option data-type="">请选择配件名称</option>');
            } else {
                qibie(id, "")
            }
        })
        lei("")
        clearnull();
        $(".bao").on("click", function (event) {
            event.preventDefault();
            $.ajax({
                type: "PUT",
                url: href + "autoparts/" + id,
                data: {
                    partsType: $('#m-name option:selected').data('type'),
                    partsNum: $(".biannum").val()
                },
                dataType: 'json',
                success: function (data) {
                    if (data.msg == "success") {
                        layer.msg('<span style="font-size:20px">保存成功</span>', {
                            time: 1000, //2s后自动关闭
                        }, function () {
                            window.location.href = "jiulist.html"
                        });
                    }
                }

            });

        })
    </script>
</body>
</html>
