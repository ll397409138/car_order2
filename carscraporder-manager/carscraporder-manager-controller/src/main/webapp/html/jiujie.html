<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" type="text/css" href="../css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../css/bootstrap-datetimepicker.min.css" />
    <link rel="stylesheet" href="../layui/css/layui.css" />
    <link rel="stylesheet" type="text/css" href="../css/style.css" />
    <link rel="stylesheet" href="../lookpic/css/bootstrap-grid.min.css" />
    <link rel="stylesheet" href="../lookpic/dist/zoomify.min.css" />
    <link rel="stylesheet" href="../lookpic/css/style.css" />
    <script src="../js/jquery-3.1.1.min.js" type="text/javascript"></script>
    <script src="../js/bootstrap.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="../js/jquery.bootstrap.min.js"></script>
    <script src="../js/dropdown.js" type="text/javascript"></script>
    <script src="../js/modal.js" type="text/javascript"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=3LSsiAvyTOStAaAc4Nwb2EDyZcUc9lx8"></script>
    <script type="text/javascript" src="../layui/layui.js"></script>
    <script src="../lookpic/dist/zoomify.min.js"></script>
    <style>
        .datetimepicker {
            margin-top: 50px !important;
        }

        #allmap {
            width: 100%;
            height: 400px;
        }

        .tablelist tr {
            height: 40px;
        }
    </style>
    <title>车报废管理后台</title>
    <script type="text/javascript">
//$('.dropdown-toggle').dropdown()
    </script>
</head>
<body>
    <div class="back-stage-top">
        <h1 class="pull-left">车报废管理后台</h1>
        <h1 class="pull-right text-primary" id="loginout" style="margin-left:20px;cursor:pointer;font-size:18px;margin-right:50px;" onclick="loginout()">退出</h1>
        <h1 class="pull-right text-primary" id="loginusername" style="margin-left:20px;font-size:18px;">用户名：张三</h1>
    </div>
    <div class="backnav">
        <ul class="backnav">
            <li><a href="index.html">首页</a></li>
            <li><a href="orderlist.html">订单管理</a></li>
            <li><a href="scraplist.html">报废汽车</a></li>
            <li><a href="jiulist.html">旧件回收</a></li>
            <li class="cur"><a href="moneymanage.html">财务管理</a></li>
            <li><a href="system.html">系统设置</a></li>
        </ul>
    </div>
    <div class="tablebox">
        <ol class="breadcrumb m-t-10">
            <li><a href="index.html">首页</a></li>
            <li><a href="moneymanage.html">财务管理</a></li>
            <li>结算</li>
        </ol>
        <!--车辆信息-->
        <h2 class="text-center">订单信息：<span class="ordnum"></span></h2>
        <div class="col-md-6">
            <h4 class="page-header"><span class="glyphicon glyphicon-list-alt m-l-15"></span> 车辆信息</h4>
            <table class="tablelist">
                <tr>
                    <th width="120" class="text-right"><span class="redcolor">*</span>订单编号：</th>
                    <td><span class="ordernum"></span></td>
                </tr>
                <tr>
                    <th width="120" class="text-right"><span class="redcolor">*</span>车牌号：</th>
                    <td><span class="carnum"></span></td>
                </tr>
                <tr>
                    <th width="120" class="text-right"><span class="redcolor">*</span>车架号：</th>
                    <td><span class="carjia"></span></td>
                </tr>
                <tr>
                    <th width="120" class="text-right"><span class="redcolor">*</span>车辆型号：</th>
                    <td><span class="carxing"></span></td>
                </tr>
                <!--<tr>
                    <th width="120" class="text-right"><span class="redcolor">*</span>能否行驶：</th>
                    <td><span class="forxing"></span></td>
                </tr>-->
                <tr>
                    <th width="120" class="text-right"><span class="redcolor">*</span>报案号：</th>
                    <td><span class="carbao"></span></td>
                </tr>
                <tr>
                    <th width="120" class="text-right"><span class="redcolor">*</span>残值金额：</th>
                    <td><span class="canjimoney"></span></td>
                </tr>
            </table>
        </div>
        <!--end 车辆信息-->
        <!--取车信息-->
        <div class="col-md-6">
            <h4 class="page-header"><span class="glyphicon glyphicon-list-alt m-l-15"></span> 取车信息</h4>
            <table class="tablelist">
                <tr>
                    <th width="120" class="text-right"><span class="redcolor">*</span>取车联系人：</th>
                    <td>
                        <div class="input-group">
                            <!--常用联系人-->
                            <span id="changren"></span>
                            <!--<input type="text" id="changren" class="form-control" placeholder="">
                            <span class="input-group-btn">
                              <button class="btn btn-default quan" type="button" >常用联系人</button>
                            </span>-->
                        </div>
                    </td>
                </tr>
                <tr>
                    <th width="120" class="text-right"><span class="redcolor">*</span>联系人电话：</th>
                    <td><span class="perphone"></span></td>
                </tr>

                <tr>
                    <th width="120" class="text-right"><span class="redcolor">*</span>取车时间：</th>
                    <td>
                        <div class="input-group">
                            <span id="checktime"></span>
                            <!--<span role="button"  class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>-->
                        </div>
                    </td>
                </tr>
                <tr>
                    <th width="120" class="text-right"><span class="redcolor">*</span>取车地址：</th>
                    <td><span class="setmap"></span></td>
                </tr>
                <tr>
                    <td></td>
                    <td>您当前选择的城市为<i class="text-primary">北京</i>，取车地址只能为北京。</td>
                </tr>
                <tr>
                    <td></td>
                    <td>
                        <label>
                            <!--  <input type="checkbox"> 将该联系人设置为常用联系人-->
                        </label>
                    </td>
                </tr>
            </table>
        </div>
        <!--end 取车信息-->
        <div class="clearfix"></div>
        <!--车辆照片-->
        <div class="col-md-10">
            <div class="carpics">
                <div>
                    <div class="page-header">
                        <h4 class="pull-left"><span class="glyphicon glyphicon-list-alt m-l-15"></span> 配件信息</h4>
                        <!--<button type="button" class="btn btn-primary pull-right peibtn" >+ 添加配件</button>-->
                        <div class="clearfix"></div>
                    </div>
                    <table class="table table-striped addtab">
                        <thead>
                            <tr>
                                <th>配件分类</th>
                                <th>配件名称</th>
                                <th>零件编号</th>
                                <th>残值金额</th>
                                <th>取回时间</th>
                                <th>备注</th>
                                <th width="50%">配件照片</th>
                                <!--<th>编辑</th>-->
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="clearfix"></div>
        <div class="col-md-6">
            <h4><span class="glyphicon glyphicon-list-alt m-l-15"></span> 财务结算</h4>
            <table class="tablelist" style="text-align: left;">
                <tr>
                    <th width="80" style="text-align: right;">残值金额：</th>
                    <td>
                        <span class="showcajini"></span>
                    </td>
                    <td>
                        <button type="button" class="btn btn-primary pull-left peijie">结算</button>
                    </td>
                </tr>
            </table>
        </div>
        <!--配件信息-->
        <div class="clearfix"></div>
        <div class="col-md-8">
            <div class="page-header">
                <h4 class="pull-left"><span class="glyphicon glyphicon-list-alt m-l-15"></span> 结算历史</h4>
                <!--<button type="button" class="btn btn-primary pull-right peibtn" >+ 添加配件</button>-->
                <div class="clearfix"></div>
            </div>
            <table class="table table-striped addtab2">
                <thead>
                    <tr>
                        <th>结算日期</th>
                        <th>结算金额</th>
                        <th>操作人</th>
                        <th>备注</th>
                        <th width="50%">操作</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="hide">
            <div id="detailState">
                <table class="table table-striped addren">
                    <thead><tr><th>配件分类</th><th>配件名称</th><th>零件编号</th><th>残值金额</th><th>已结算金额</th><th>本次结算金额</th><th>备注</th></tr></thead>
                    <tbody></tbody>
                </table>
                <div class="form-group form-inline clearfix">
                    转账流水单号：
                    <input type="text" value="" style="width:400px;" class="form-control checkLogs" id="liudan" placeholder="" autocomplete="off" />
                </div>
            </div>
        </div>
        <script src="../js/bootstrap-datetimepicker.min.js"></script>
        <script src="../js/bootstrap-datetimepicker.zh-CN.js"></script>
        <script src="../js/comm.js"></script>
        <script>
            (function ($) {
                $.getUrlParam = function (name) {
                    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
                    var r = window.location.search.substr(1).match(reg);
                    if (r != null) return unescape(r[2]);
                    return null;
                }
            })(jQuery);
            var id = $.getUrlParam('id');
            layui.use('layer', function () {

            });
            var jiemoney = 0;
            $.ajax({
                type: "get",
                url: href + 'order/' + id,
                dataType: "json",
                success: function (data) {
                    if (data.msg == "success") {
                        var d = data.data;
                        $(".ordernum").html(d.orderNo);
                        $(".carnum").html(d.custormName);
                        $(".carjia").html(d.carFrameNumber);
                        $(".carxing").html(d.carModelNumber);
                        $(".carbao").html(d.reportNo);
                        $(".canjimoney").html(d.orderAmount);
                        $("#changren").html(d.takeCarContacts);
                        $(".perphone").html(d.takeCarContactNumber);
                        $("#checktime").html(d.takeCarTime);
                        $(".setmap").html(d.takeCarAddress);
                        //				pai(d.orderAreasId,"");
                        var dd = d.carScrapOrderAutopartsList;
                        var f = d.settlementList;
                        if (dd.length) {
                            var otr = "";
                            for (var i = 0; i < dd.length; i++) {
                                otr += '<tr>'
                                otr += '<td>' + dd[i].partsCaregoryName + '</td>'
                                otr += '<td>' + dd[i].partsTypeName + '</td>'
                                otr += '<td>' + dd[i].partsNum + '</td>'
                                otr += '<td>' + dd[i].amount + '</td>'
                                otr += '<td>' + dd[i].receiveTime + '</td>'
                                otr += '<td>' + dd[i].remark + '</td>';
                                var pics = dd[i].autoPartsPictures;
                                jiemoney += dd[i].amount;
                                var obj = "";
                                var urls = [], ids = [];
                                if (pics.length) {
                                    for (var j = 0; j < pics.length; j++) {
                                        console.log(j)
                                        urls.push(pics[j].url);
                                        ids.push(pics[j].id)
                                        obj += '<div class="col-md-3 col-xs-6">'
                                        obj += '<div class="thumbnail"><img style="display:block;width:100%;height:100px" class="img-rounded" src="' + pics[j].url + '" /></div>'
                                        obj += '</div>'
                                    }
                                };
                                var urrs = urls.join();
                                var idss = ids.join();
                                otr += '<td> <div class="row">' + obj + '</div></td>'
                                otr += '</tr>'


                            };
                            $(".addtab tbody").html(otr);
                            for (var i = 0; i < $(".addtab td").length; i++) {
                                if ($(".addtab td").eq(i).text() == null || $(".addtab td").eq(i).text() == "null") {
                                    $(".addtab td").eq(i).html("")
                                }
                            }
                            //初始化话图片
                            $(".addtab tbody  img").zoomify();
                            $(".showcajini").html(jiemoney);
                        };
                        if (f.length) {
                            var objs = "";
                            for (var i = 0; i < f.length; i++) {
                                objs += '<tr>'
                                objs += '<td>' + f[i].settlementTime + '</td>'
                                objs += '<td>' + f[i].settlementAmount + '</td>'
                                objs += '<td>' + f[i].settlementerName + '</td>'
                                objs += '<td>' + f[i].settlementRemarks + '</td>'
                                objs += '<td>更多详情</td>'
                                objs += '</tr>'
                            };
                            $(".addtab2 tbody").html(objs);
                            for (var i = 0; i < $(".addtab2 td").length; i++) {
                                if ($(".addtab2 td").eq(i).text() == null || $(".addtab2 td").eq(i).text() == "null") {
                                    $(".addtab2 td").eq(i).html("")
                                }
                            }
                        } else {

                        }
                    }
                }
            });

            //结算
            $(document).delegate('.peijie', 'click', function (event) {
                event.preventDefault();
                $.ajax({
                    type: "get",
                    url: href + "autoparts/listbyorderid?orderid=" + id,
                    dataType: 'json',
                    success: function (data) {
                        if (data.msg == "success") {
                            var dd = data.data;
                            if (dd.length) {
                                var otr = "";
                                var t1 = 0;
                                var t2 = 0;
                                for (var i = 0; i < dd.length; i++) {
                                    otr += '<tr>'
                                    otr += '<td>' + dd[i].partsCaregoryName + '</td>'
                                    otr += '<td>' + dd[i].partsTypeName + '</td>'
                                    otr += '<td>' + dd[i].partsNum + '</td>'
                                    otr += '<td>' + dd[i].amount + '</td>'
                                    otr += '<td>' + dd[i].settledAmount + '</td>'
                                    otr += '<td><input type="text" value="" style="width:100px;" class="form-control checkLogs benmoney" data-id="' + dd[i].id + '" value="" placeholder="" autocomplete="off"></td>'
                                    otr += '<td><input type="text" value="" style="width:100px;" class="form-control checkLogs benbei" data-id="' + dd[i].id + '" value="" placeholder="" autocomplete="off"></td>'
                                    otr += '</tr>';
                                    t1 += dd[i].amount;
                                    t2 += dd[i].settledAmount
                                };

                                otr += '<tr><td>本次合计金额</td><td></td><td></td><td>' + t1 + '</td><td>' + t2 + '</td><td><span class="allmoney"></span></td><td></td></tr>'
                                $(".addren tbody").html(otr);
                                for (var i = 0; i < $(".addren td").length; i++) {
                                    if ($(".addren td").eq(i).text() == null || $(".addren td").eq(i).text() == "null") {
                                        $(".addren td").eq(i).html("")
                                    }
                                }
                            };
                        }
                    }

                });
                $('#detailState').dialog({
                    title: '结算',
                    onClose: function () {
                        $(this).dialog('close');
                    },
                    buttons: [{
                        text: '取消',
                        'click': function () {
                            $(this).dialog('close');
                        }
                    }, {
                        text: '确定',
                        'class': 'btn-primary',
                        'click': function () {
                            var arr = [];
                            for (var i = 0; i < $(".benmoney").length; i++) {
                                arr.push({
                                    settlementAmount: $(".benmoney").eq(i).val(),
                                    settlementObjectId: $(".benmoney").eq(i).attr("data-id"),
                                    settlementRemarks: $(".benbei").eq(i).val(),
                                    settlementType: 2
                                })
                            };
                            var senddata = {
                                flow: $("#liudan").val(),
                                orderid: id,
                                settlementInfos: arr
                            }
                            $.ajax({
                                type: "post",
                                url: href + "settlementFlow",
                                data: JSON.stringify(senddata),
                                contentType: "application/json;charset=utf-8",
                                dataType: "json",
                                success: function (data) {
                                    if (data.msg == "success") {
                                        layer.msg('<span style="font-size:20px">结算成功</span>', {
                                            time: 1000, //2s后自动关闭
                                        }, function () {
                                            window.location.reload()
                                        });
                                    }
                                }
                            });
                        }
                    }]
                })
            });
            //监听结算金额的bianhua
            $(".addren").on("keyup", '.benmoney', function () {
                var allnum = 0;
                if ($(".benmoney").length) {
                    for (var i = 0; i < $(".benmoney").length; i++) {
                        if ($(".benmoney").eq(i).val() == "") {
                            allnum += 0;
                        } else {
                            allnum += parseFloat($(".benmoney").eq(i).val());
                        }
                    }

                };
                $(".allmoney").html(allnum)
            })
        </script>
    </div>
</body>
</html>
